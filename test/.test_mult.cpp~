// Copyright 2018 Alexander Wietek - All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//    http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include "catch.hpp"

#include <lila/matrix.h>
#include <lila/random.h>
#include <lila/special.h>
#include <lila/mult.h>
#include <lila/print.h>
#include <lila/compare.h>

template <class coeff_t>
lila::Matrix<coeff_t> simple_multiply(const lila::Matrix<coeff_t>& A, 
				      const lila::Matrix<coeff_t>& B)
{
  lila::Matrix<coeff_t> C(A.nrows(), B.ncols());
  lila::Zeros(C);
  
  for (auto i : C.rows())
    for (auto j : C.cols())
      for (auto k : A.cols())
	C(i,j) += A(i,k)*B(k,j);
  return C;
}

TEST_CASE( "Matrix multiplication test", "[Mult]" ) {

  int m=3;
  int k=4;
  int n=5;

  int seed=42;
  
  lila::uniform_dist_t<float> fdist(-1., 1.);
  lila::uniform_gen_t<float> fgen(fdist, seed);
  
  lila::Matrix<float> A(m, k);
  lila::Matrix<float> B(k, n);
  lila::Matrix<float> C(m, n);
  Random(A, fgen);  
  Random(B, fgen);
  Random(C, fgen);
  Mult(A, B, C);
  Print(A);
  Print(B);
  Print(C);
  lila::Matrix<float> C2 = simple_multiply(A, B);
  Print(C2);
  REQUIRE(lila::close<float>(C, C2));

  Mult(B, A, C, float(1.), float(0.), 'T', 'T');
  Print(A);
  Print(B);
  Print(C);

  A.resize(m, k);
  B.resize(n, k);
  Mult(A, B, C, float(1.), float(0.), 'N', 'T');
  Print(A);
  Print(B);
  Print(C);

  A.resize(k, m);
  B.resize(k, n);
  Mult(A, B, C, float(1.), float(0.), 'T', 'N');
  Print(A);
  Print(B);
  Print(C);

}
